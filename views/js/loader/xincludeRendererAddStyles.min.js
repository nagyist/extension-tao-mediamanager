function _wrapRegExp(){function BabelRegExp(re,flags,groups){var _this=new RegExp(re,flags);return _groups.set(_this,groups||_groups.get(re)),_setPrototypeOf(_this,BabelRegExp.prototype)}function buildGroups(result,re){var g=_groups.get(re);return Object.keys(g).reduce(function(groups,name){return groups[name]=result[g[name]],groups},Object.create(null))}_wrapRegExp=function _wrapRegExp(re,groups){return new BabelRegExp(re,void 0,groups)};var _super=RegExp.prototype,_groups=new WeakMap;return _inherits(BabelRegExp,RegExp),BabelRegExp.prototype.exec=function(str){var result=_super.exec.call(this,str);return result&&(result.groups=buildGroups(result,this)),result},BabelRegExp.prototype[Symbol.replace]=function(str,substitution){if("string"==typeof substitution){var groups=_groups.get(this);return _super[Symbol.replace].call(this,str,substitution.replace(/\$<([^>]+)>/g,function(_,name){return"$"+groups[name]}))}if("function"==typeof substitution){var _this=this;return _super[Symbol.replace].call(this,str,function(){var args=arguments;return"object"!=_typeof(args[args.length-1])&&(args=[].slice.call(args)).push(buildGroups(args,_this)),substitution.apply(this,args)})}return _super[Symbol.replace].call(this,str,substitution)},_wrapRegExp.apply(this,arguments)}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function");subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:!0,configurable:!0}}),Object.defineProperty(subClass,"prototype",{writable:!1}),superClass&&_setPrototypeOf(subClass,superClass)}function _setPrototypeOf(o,p){return _setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(o,p){return o.__proto__=p,o},_setPrototypeOf(o,p)}function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}function _createForOfIteratorHelper(o,allowArrayLike){var it="undefined"!=typeof Symbol&&o[Symbol.iterator]||o["@@iterator"];if(!it){if(Array.isArray(o)||(it=_unsupportedIterableToArray(o))||allowArrayLike&&o&&"number"==typeof o.length){it&&(o=it);var i=0,F=function F(){};return{s:F,n:function n(){return i>=o.length?{done:!0}:{done:!1,value:o[i++]}},e:function e(_e){throw _e},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var err,normalCompletion=!0,didErr=!1;return{s:function s(){it=it.call(o)},n:function n(){var step=it.next();return normalCompletion=step.done,step},e:function e(_e2){didErr=!0,err=_e2},f:function f(){try{normalCompletion||null==it.return||it.return()}finally{if(didErr)throw err}}}}function _unsupportedIterableToArray(o,minLen){if(o){if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);return"Object"===n&&o.constructor&&(n=o.constructor.name),"Map"===n||"Set"===n?Array.from(o):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(o,minLen):void 0}}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=Array(len);i<len;i++)arr2[i]=arr[i];return arr2}(function(){"use strict";var loaderScript=document.getElementById("amd-loader"),configUrl=loaderScript.getAttribute("data-config"),bundle=loaderScript.getAttribute("data-bundle"),loadController=function loadController(){var controllerOptions={},controllerPath=loaderScript.getAttribute("data-controller"),params=loaderScript.getAttribute("data-params");try{controllerOptions=JSON.parse(params)}catch(err){controllerOptions={}}window.require([controllerPath],function(controller){var startController=function startController(){window.started||(window.started=!0,controller.start(controllerOptions))};document.addEventListener("readystatechange",startController,!1),"complete"===document.readyState&&startController()})};window.require([configUrl],function(){window.loadBundles||(window.loaded={},window.loadBundles=function loadBundles(bundles){bundles=bundles||[],bundles=bundles.concat(window.bundles),bundles=bundles.filter(function(item,index){return item&&bundles.indexOf(item)===index&&!0!==window.loaded[item]}),require(bundles,function(){bundles.forEach(function(item){window.loaded[item]=!0}),loadController()})}),bundle||window.bundles&&window.bundles.length?window.loadBundles([bundle]):loadController()})})(),define("loader/bootstrap",function(){}),define("taoMediaManager/qtiCreator/helper/formatStyles",["jquery"],function($){"use strict";function getStyles(stylesheetPrefix){var duplicated=!!(1<arguments.length&&arguments[1]!==void 0)&&arguments[1],assetStyles=$("link[data-serial*=".concat(stylesheetPrefix,"]"));assetStyles.each(function(i,style){if(style){var assets="",assetClassName="";if(duplicated){var assetHref=$("link[href=\"".concat(style.href,"\"]"));assetHref&&1<assetHref.length&&assetHref.each(function(j,styleNone){styleNone.attributes["data-serial"].value.match(/[\w-]*stylesheet_[\w-]*/g)&&(styleNone.disabled=!0)}),$(".preview-content .qti-include").length?assets=$(".preview-content .qti-include"):$(".previewer-test-component .qti-include").length&&(assets=$(".previewer-test-component .qti-include"))}else assets=$(".qti-itemBody");assets.length&&assets.each(function(h,asset){var hasClass=asset.className.match(/[\w-]*tao-[\w-]*/g);if(!!hasClass&&hasClass.length&&(assetClassName=hasClass[0]),style.sheet){var stylesheetName=style.href.split("&stylesheet=");if(stylesheetName&&"tao-user-styles.css"!==stylesheetName[1]){var rdf_styles=stylesheetName[0].split("%23").reverse()[0],rdf_asset=asset.dataset.href&&asset.dataset.href.split("_").reverse()[0];(rdf_styles===rdf_asset||"stylesheet"!==stylesheetPrefix)&&formatStyles(style.sheet,assetClassName)}}else{var renderLayout=$("#item-editor-panel .qti-itemBody .qti-include > div");if(renderLayout.length){var renderHasClass=renderLayout[h].className.match(/[\w-]*tao-[\w-]*/g);!hasClass&&renderHasClass&&renderHasClass.length&&(assetClassName=renderHasClass[0],$(asset).addClass(assetClassName))}duplicated&&(assetClassName="");var assetHref2=$("link[href=\"".concat(style.href,"\"]:not([disabled])")),_stylesheetName=style.href.split("stylesheet=");_stylesheetName&&"tao-user-styles.css"!==_stylesheetName[1]&&assetHref2.length&&formatStyles(assetHref2[0].sheet,assetClassName)}})}})}function formatStyles(linkTag,className){var _ref=linkTag&&linkTag.sheet||linkTag||{},cssRules=_ref.cssRules,CSSStyleSheet=linkTag&&linkTag.sheet||linkTag||{},classNameFormated=className&&className.length?".".concat(className):"",scopedCssRules=_scopeStyles(cssRules,classNameFormated,["body html *"]);if(cssRules){Object.values(cssRules).map(function(index,rule){CSSStyleSheet.deleteRule(index)});var newRules=scopedCssRules.split("\n");Object.values(newRules).map(function(rule){CSSStyleSheet.insertRule(rule)})}}function _scopeStyles(cssRules,scopeSelector,toReplace,replacementSelector){if(!cssRules)return"";replacementSelector||(replacementSelector=scopeSelector);var scopedStyles=Object.values(cssRules).map(function(rule){if(!rule.selectorText)return"";var _step,rulesInBrackets=rule.cssText.substr(rule.selectorText.length).trim(),selectors=rule.selectorText.split(/\s*,\s*/),scopedSelectors=[],_iterator=_createForOfIteratorHelper(selectors);try{for(_iterator.s();!(_step=_iterator.n()).done;){var singleSelectorText=_step.value;if(!["html","body","*"].includes(singleSelectorText)){if(scopeSelector&&toReplace){var _step2,_iterator2=_createForOfIteratorHelper(toReplace);try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var toReplaceSelector=_step2.value;singleSelectorText.includes(toReplaceSelector)&&(singleSelectorText=singleSelectorText.replace(new RegExp(toReplaceSelector,"ig"),replacementSelector))}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}}var containsScopeSelector=singleSelectorText.includes("".concat(scopeSelector," "))||singleSelectorText.startsWith(scopeSelector)||singleSelectorText.endsWith(scopeSelector);scopeSelector&&!containsScopeSelector?scopedSelectors.push("".concat(scopeSelector," ").concat(singleSelectorText)):scopedSelectors.push(singleSelectorText)}}}catch(err){_iterator.e(err)}finally{_iterator.f()}return scopedSelectors.length?"".concat(scopedSelectors.join(",")," ").concat(rulesInBrackets):""});return scopedStyles.filter(function(str){return 0<str.length}).join("\n")};return{formatStyles:formatStyles,getStyles:getStyles}}),define("tpl!taoMediaManager/qtiCreator/tpl/toolbars/cssToggler",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{};var stack1,helper,buffer="",functionType="function",escapeExpression=this.escapeExpression;return buffer+="<li data-css-res=\"",(helper=helpers.path)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.path,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"\">\n    <span class=\"icon-preview style-sheet-toggler\" title=\"",(helper=helpers.title)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.title,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"\"></span>\n    <span class=\"file-label truncate\" title=\"",(helper=helpers.editLabelTxt)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.editLabelTxt,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"\">",(helper=helpers.label)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.label,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"</span>\n    <input type=\"text\" class=\"style-sheet-label-editor\" value=\"",(helper=helpers.label)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.label,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"\">\n    <span class=\"icon-bin\" title=\"",(helper=helpers.deleteTxt)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.deleteTxt,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"\" data-role=\"css-delete\"></span>\n    <span class=\"icon-download\" title=\"",(helper=helpers.downloadTxt)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.downloadTxt,stack1="function"===_typeof(helper)?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"\" data-role=\"css-download\"></span>\n</li>",buffer})}),define("taoMediaManager/qtiCreator/editor/styleEditor/styleEditor",["jquery","lodash","i18n","util/urlParser","core/dataProvider/request","tpl!taoMediaManager/qtiCreator/tpl/toolbars/cssToggler","taoMediaManager/qtiCreator/helper/formatStyles","util/url","services/features","jquery.fileDownload"],function($,_,__,UrlParser,request,cssTpl,formatStyles,urlUtil,featuresService){"use strict";var itemConfig,globalConfig,currentItem,styleSheetManagerVisibilityKey="taoMediaManager/creator/StyleSheetManager",_getUri=function _getUri(action){return globalConfig["".concat(action,"CssUrl")]},_basename=function _basename(path){return path.substring(path.lastIndexOf("/")+1)},mainClassSelector="mainClass",hashClassSelector="hashClass",taoHashClassPrefix="tao-",hashClass="",mainClass="",style={},customStylesheet="",$styleElem=function(){var styleElem=$("#item-editor-user-styles");return styleElem.length?styleElem.empty():(styleElem=$("<style>",{id:"item-editor-user-styles"}),$("head").append(styleElem)),styleElem}(),common={title:__("Disable this stylesheet temporarily"),deleteTxt:__("Remove this stylesheet"),editLabelTxt:__("Edit stylesheet label"),downloadTxt:__("Download this stylesheet"),preparingMessageHtml:__("Preparing CSS, please wait\u2026"),failMessageHtml:__("There was a problem downloading your CSS, please try again."),isInValidLocalTxt:__("This stylesheet has not been found on the server. you may want to delete this reference")},erase=function erase(){return style={},$styleElem.text(""),!1},create=function create(dontAppend){var mSelector,mProp,css="";return _.isEmpty(style)?erase():(_.forEach(style,function(value1,key1){css+="".concat(key1,"{"),_.forEach(value1,function(value2,key2){if(_.isPlainObject(value2))for(mSelector in value2){for(mProp in css+="".concat(key2,"{"),value2)css+="".concat(mProp,":").concat(value2[mSelector],";");css+="}"}else css+="".concat(key2,":").concat(value2,";")}),css+="}\n"}),dontAppend||$styleElem.text(css),css)},apply=function apply(selector,property,value){var itemBodyClass=document.querySelector(".qti-itemBody").classList;itemBodyClass.forEach(function(className){var searchClass=className.match(_wrapRegExp(/(tao\x2D\w+)?/,{className:1}));searchClass.groups.className&&(mainClass=searchClass.groups.className)}),selector=selector.replace(mainClassSelector,mainClass),selector=selector.replace(hashClassSelector,hashClass),style[selector]=style[selector]||{},value?style[selector][property]=value:(delete style[selector][property],0===_.size(style[selector])&&delete style[selector]),create(),$(document).trigger("stylechange.qti-creator")},verifyInit=function verifyInit(){if(!itemConfig)throw new Error("Missing itemConfig, did you call styleEditor.init()?");return!0},save=function save(){return verifyInit(),request(_getUri("save"),_.extend({},itemConfig,{cssJson:JSON.stringify(style),stylesheetUri:customStylesheet.attr("href")}),"POST")},deleteStylesheet=function deleteStylesheet(stylesheet){return verifyInit(),request(_getUri("save"),_.extend({},itemConfig,{cssJson:JSON.stringify({}),stylesheetUri:"css/".concat(stylesheet.attr("title"))}),"POST")},download=function download(uri,name){verifyInit();var style=uri.match(_wrapRegExp(/stylesheet=(\w+)?/,{groupName:1})),styleName="";style&&style.groups&&style.groups.groupName&&(styleName="".concat(style.groups.groupName,".css"));var downloadUrl=urlUtil.build(_getUri("download"),{uri:globalConfig.id,stylesheet:styleName});fetch(downloadUrl).then(function(resp){return resp.blob()}).then(function(blob){var url=window.URL.createObjectURL(blob),a=document.createElement("a");a.style.display="none",a.href=url,a.download=name,document.body.appendChild(a),a.click(),window.URL.revokeObjectURL(url)}).catch(function(){return common.failMessageHtml})},addStylesheet=function addStylesheet(stylesheet,itemConfig){function loadStylesheet(linkElement,stylesheetObject,isLocal,isValid){var isInvalidLocal=isLocal&&!isValid,tplData={path:stylesheetObject.attr("href"),label:stylesheetObject.attr("title")||fileName,title:common.title,deleteTxt:common.deleteTxt,downloadTxt:common.downloadTxt,editLabelTxt:isInvalidLocal?common.isInValidLocalTxt:common.editLabelTxt};return listEntry=$(cssTpl(tplData)),listEntry.data("stylesheetObj",stylesheetObject),$("#style-sheet-toggler").append(listEntry),isInvalidLocal?(listEntry.addClass("not-available"),void listEntry.find("[data-role=\"css-download\"], .style-sheet-toggler").css("visibility","hidden")):void($styleElem.before(linkElement),setTimeout(function(){var cssFile=$("[href=\"".concat(link[0].href,"\"]"));cssFile&&cssFile[0].sheet&&formatStyles.formatStyles(cssFile[0].sheet,mainClass);var isInit=!1;$(document).trigger("customcssloaded.styleeditor",[style]),$(window).trigger("resize"),currentItem.pendingStylesheetsInit&&(isInit=!0,currentItem.pendingStylesheetsInit--),$(document).trigger("stylechange.qti-creator",[{initializing:isInit}])},isLocal?500:3500))}var fileName,link,listEntry,parser;_.isString(stylesheet)&&(stylesheet=currentItem.createStyleSheet(stylesheet)),fileName=_basename(stylesheet.attr("href")),link=function(){var _link=$(stylesheet.render()),_href=itemConfig&&urlUtil.route("loadStylesheet","SharedStimulusStyling","taoMediaManager",{uri:itemConfig.id,stylesheet:fileName})||_link.attr("href"),_sep=-1<_href.indexOf("?")?"&":"?";return _link.attr("href",_href+_sep+new Date().getTime().toString()),_link}(),parser=new UrlParser(link.attr("href")),parser.checkCORS()?$.when($.ajax(link.attr("href"))).then(function(){loadStylesheet(link,stylesheet,!0,!0)},function(){loadStylesheet(link,stylesheet,!0,!1)}):loadStylesheet(link,stylesheet,!1)},addItemStylesheets=function addItemStylesheets(){var currentStylesheet;currentItem.pendingStylesheetsInit=_.size(currentItem.stylesheets),_.forEach(currentItem.stylesheets,function(value){currentStylesheet=value,"tao-user-styles.css"===_basename(currentStylesheet.attr("href"))?customStylesheet=currentStylesheet:addStylesheet(value)}),customStylesheet||(customStylesheet=currentItem.createStyleSheet("css/tao-user-styles.css"))},removeOrphanedStylesheets=function removeOrphanedStylesheets(){$("link[data-serial]").remove(),customStylesheet=null,erase()},getItem=function getItem(){return currentItem},init=function init(item,config){var href;globalConfig=config,currentItem=item,itemConfig={uri:config.id,lang:config.lang},removeOrphanedStylesheets(),addItemStylesheets(),href=customStylesheet.attr("href"),currentItem.data("responsive",!0),request(_getUri("load"),_.extend({},itemConfig,{stylesheetUri:href})).then(function(_style){style=_style,create(),$(document).trigger("customcssloaded.styleeditor",[style])}),featuresService.isVisible("taoMediaManager/creator/StyleSheetManager",!1)&&$("#sidebar-right-css-manager").show()},getStyle=function getStyle(){return style},getHashClass=function getHashClass(){return hashClass},getMainClass=function getMainClass(){return mainClass},setHashClass=function setHashClass(cssClass){hashClass=cssClass},setMainClass=function setMainClass(cssClass){mainClass=cssClass},generateHashClass=function generateHashClass(){return hashClass="".concat(taoHashClassPrefix).concat(Math.random().toString(36).substr(2,9))},generateMainClass=function generateMainClass(){return mainClass="".concat(taoHashClassPrefix).concat(Math.random().toString(36).substr(2,9))},replaceHashClass=function replaceHashClass(selector){return hashClass&&selector.replace(hashClassSelector,hashClass)||selector},replaceMainClass=function replaceMainClass(selector){return mainClass&&selector.replace(mainClassSelector,mainClass)||selector},clearCache=function clearCache(){removeOrphanedStylesheets(),$(document).off("customcssloaded.styleeditor")};return{apply:apply,save:save,deleteStylesheet:deleteStylesheet,download:download,erase:erase,init:init,create:create,getItem:getItem,getStyle:getStyle,addStylesheet:addStylesheet,getHashClass:getHashClass,setHashClass:setHashClass,generateHashClass:generateHashClass,replaceHashClass:replaceHashClass,getMainClass:getMainClass,setMainClass:setMainClass,generateMainClass:generateMainClass,replaceMainClass:replaceMainClass,clearCache:clearCache}}),define("taoMediaManager/richPassage/xincludeRendererAddStyles",["lodash","jquery","uri","util/url","core/dataProvider/request","taoMediaManager/qtiCreator/helper/formatStyles","taoMediaManager/qtiCreator/editor/styleEditor/styleEditor"],function(_,$,uri,urlUtil,request,formatStyles,styleEditor){"use strict";return function xincludeRendererAddStyles(passageHref,passageClassName,serial){var head=3<arguments.length&&arguments[3]!==void 0?arguments[3]:$("head");if(/taomedia:\/\/mediamanager\//.test(passageHref)){var passageUri=uri.decode(passageHref.replace("taomedia://mediamanager/",""));request(urlUtil.route("getStylesheets","SharedStimulusStyling","taoMediaManager"),{uri:passageUri}).then(function(response){response.children.forEach(function(element){var link=urlUtil.route("loadStylesheet","SharedStimulusStyling","taoMediaManager",{uri:passageUri,stylesheet:element.name}),styleElem=$("<link>",{rel:"stylesheet",type:"text/css",href:link,"data-serial":passageUri}),layout=head.find("link[href=\"".concat(link,"\"]"));layout.length||(head.append(styleElem[0]),"tao-user-styles.css"!==element.name&&serial.length&&setTimeout(function(){if(!passageClassName){passageClassName=styleEditor.generateMainClass();var _layout=$("[data-serial=\"".concat(serial,"\"] .qti-include > div")),hasClass=_layout.className&&_layout.className.match(/[\w-]*tao-[\w-]*/g);hasClass||_layout.addClass(passageClassName)}var cssFile=$("link[href=\"".concat(link,"\"]"));cssFile.each(function(i,e){var isFormat=e.dataset&&e.dataset.format;!isFormat&&e&&(e.dataset.format=!0,formatStyles.formatStyles(e.sheet,passageClassName))})},500))})}).catch()}}}),define("taoMediaManager/loader/xincludeRendererAddStyles.bundle",function(){});
//# sourceMappingURL=xincludeRendererAddStyles.min.js.map