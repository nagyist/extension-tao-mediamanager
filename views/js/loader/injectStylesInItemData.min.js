function _createForOfIteratorHelper(o,allowArrayLike){var it="undefined"!=typeof Symbol&&o[Symbol.iterator]||o["@@iterator"];if(!it){if(Array.isArray(o)||(it=_unsupportedIterableToArray(o))||allowArrayLike&&o&&"number"==typeof o.length){it&&(o=it);var i=0,F=function F(){};return{s:F,n:function n(){return i>=o.length?{done:!0}:{done:!1,value:o[i++]}},e:function e(_e){throw _e},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var err,normalCompletion=!0,didErr=!1;return{s:function s(){it=it.call(o)},n:function n(){var step=it.next();return normalCompletion=step.done,step},e:function e(_e2){didErr=!0,err=_e2},f:function f(){try{normalCompletion||null==it.return||it.return()}finally{if(didErr)throw err}}}}function _unsupportedIterableToArray(o,minLen){if(o){if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);return"Object"===n&&o.constructor&&(n=o.constructor.name),"Map"===n||"Set"===n?Array.from(o):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(o,minLen):void 0}}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=Array(len);i<len;i++)arr2[i]=arr[i];return arr2}(function(){"use strict";var loaderScript=document.getElementById("amd-loader"),configUrl=loaderScript.getAttribute("data-config"),bundle=loaderScript.getAttribute("data-bundle"),loadController=function loadController(){var controllerOptions={},controllerPath=loaderScript.getAttribute("data-controller"),params=loaderScript.getAttribute("data-params");try{controllerOptions=JSON.parse(params)}catch(err){controllerOptions={}}window.require([controllerPath],function(controller){var startController=function startController(){window.started||(window.started=!0,controller.start(controllerOptions))};document.addEventListener("readystatechange",startController,!1),"complete"===document.readyState&&startController()})};window.require([configUrl],function(){window.loadBundles||(window.loaded={},window.loadBundles=function loadBundles(bundles){bundles=bundles||[],bundles=bundles.concat(window.bundles),bundles=bundles.filter(function(item,index){return item&&bundles.indexOf(item)===index&&!0!==window.loaded[item]}),require(bundles,function(){bundles.forEach(function(item){window.loaded[item]=!0}),loadController()})}),bundle||window.bundles&&window.bundles.length?window.loadBundles([bundle]):loadController()})})(),define("loader/bootstrap",function(){}),define("taoMediaManager/qtiCreator/helper/formatStyles",["jquery"],function($){"use strict";function getStyles(stylesheetPrefix){var duplicated=!!(1<arguments.length&&arguments[1]!==void 0)&&arguments[1],assetStyles=$("link[data-serial*=".concat(stylesheetPrefix,"]"));assetStyles.each(function(i,style){if(style){var assets="",assetClassName="";if(duplicated){var assetHref=$("link[href=\"".concat(style.href,"\"]"));assetHref&&1<assetHref.length&&assetHref.each(function(j,styleNone){styleNone.attributes["data-serial"].value.match(/[\w-]*stylesheet_[\w-]*/g)&&(styleNone.disabled=!0)}),$(".preview-content .qti-include").length?assets=$(".preview-content .qti-include"):$(".previewer-test-component .qti-include").length&&(assets=$(".previewer-test-component .qti-include"))}else assets=$(".qti-itemBody");assets.length&&assets.each(function(h,asset){var hasClass=asset.className.match(/[\w-]*tao-[\w-]*/g);if(!!hasClass&&hasClass.length&&(assetClassName=hasClass[0]),style.sheet){var stylesheetName=style.href.split("&stylesheet=");if(stylesheetName&&"tao-user-styles.css"!==stylesheetName[1]){var rdf_styles=stylesheetName[0].split("%23").reverse()[0],rdf_asset=asset.dataset.href&&asset.dataset.href.split("_").reverse()[0];(rdf_styles===rdf_asset||"stylesheet"!==stylesheetPrefix)&&formatStyles(style.sheet,assetClassName)}}else{var renderLayout=$("#item-editor-panel .qti-itemBody .qti-include > div");if(renderLayout.length){var renderHasClass=renderLayout[h].className.match(/[\w-]*tao-[\w-]*/g);!hasClass&&renderHasClass&&renderHasClass.length&&(assetClassName=renderHasClass[0],$(asset).addClass(assetClassName))}duplicated&&(assetClassName="");var assetHref2=$("link[href=\"".concat(style.href,"\"]:not([disabled])")),_stylesheetName=style.href.split("stylesheet=");_stylesheetName&&"tao-user-styles.css"!==_stylesheetName[1]&&assetHref2.length&&formatStyles(assetHref2[0].sheet,assetClassName)}})}})}function formatStyles(linkTag,className){var _ref=linkTag&&linkTag.sheet||linkTag||{},cssRules=_ref.cssRules,CSSStyleSheet=linkTag&&linkTag.sheet||linkTag||{},classNameFormated=className&&className.length?".".concat(className):"",scopedCssRules=_scopeStyles(cssRules,classNameFormated,["body html *"]);if(cssRules){Object.values(cssRules).map(function(index,rule){CSSStyleSheet.deleteRule(index)});var newRules=scopedCssRules.split("\n");Object.values(newRules).map(function(rule){CSSStyleSheet.insertRule(rule)})}}function _scopeStyles(cssRules,scopeSelector,toReplace,replacementSelector){if(!cssRules)return"";replacementSelector||(replacementSelector=scopeSelector);var scopedStyles=Object.values(cssRules).map(function(rule){if(!rule.selectorText)return"";var _step,rulesInBrackets=rule.cssText.substr(rule.selectorText.length).trim(),selectors=rule.selectorText.split(/\s*,\s*/),scopedSelectors=[],_iterator=_createForOfIteratorHelper(selectors);try{for(_iterator.s();!(_step=_iterator.n()).done;){var singleSelectorText=_step.value;if(!["html","body","*"].includes(singleSelectorText)){if(scopeSelector&&toReplace){var _step2,_iterator2=_createForOfIteratorHelper(toReplace);try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var toReplaceSelector=_step2.value;singleSelectorText.includes(toReplaceSelector)&&(singleSelectorText=singleSelectorText.replace(new RegExp(toReplaceSelector,"ig"),replacementSelector))}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}}var containsScopeSelector=singleSelectorText.includes("".concat(scopeSelector," "))||singleSelectorText.startsWith(scopeSelector)||singleSelectorText.endsWith(scopeSelector);scopeSelector&&!containsScopeSelector?scopedSelectors.push("".concat(scopeSelector," ").concat(singleSelectorText)):scopedSelectors.push(singleSelectorText)}}}catch(err){_iterator.e(err)}finally{_iterator.f()}return scopedSelectors.length?"".concat(scopedSelectors.join(",")," ").concat(rulesInBrackets):""});return scopedStyles.filter(function(str){return 0<str.length}).join("\n")};return{formatStyles:formatStyles,getStyles:getStyles}}),define("taoMediaManager/richPassage/helpers",["lodash","uri","util/url","core/dataProvider/request","taoMediaManager/qtiCreator/helper/formatStyles"],function(_,uri,urlUtil,request,formatStyles){"use strict";function getPassagesFromElement(){var element=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},includes={};return _.forEach(["elements","choices"],function(elementCollection){"choices"===elementCollection&&_.isArray(element[elementCollection])?_.forEach(element[elementCollection],function(choiceMatch){_.forEach(choiceMatch,function(choice){includes=_.extend(includes,getPassagesFromElement(choice))})}):_.forEach(element[elementCollection],function(childElement){"include"===childElement.qtiClass?includes[childElement.serial]=childElement:includes=_.extend(includes,getPassagesFromElement(childElement))})}),element.body&&(includes=_.extend(includes,getPassagesFromElement(element.body))),element.prompt&&(includes=_.extend(includes,getPassagesFromElement(element.prompt))),includes}function getPassagesFromItemData(){var itemData=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},includes={};return itemData.content&&itemData.content.data&&itemData.content.data.body&&(includes=_.extend(includes,getPassagesFromElement(itemData.content.data.body))),includes}function injectPassagesStylesInItemData(){var elements=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},itemData=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},requests=[],passageUris=[];return _.forEach(elements,function(elem,id){var passageHref=elem.attributes.href;if(/taomedia:\/\/mediamanager\//.test(passageHref)){var passageUri=uri.decode(passageHref.replace("taomedia://mediamanager/",""));passageUris.includes(passageUri)||(passageUris.push(passageUri),requests.push(request(urlUtil.route("getStylesheets","SharedStimulusStyling","taoMediaManager"),{uri:passageUri}).then(function(response){response.children.forEach(function(element,index){var serial="stylesheet_".concat(id,"_").concat(index);itemData.content.data.stylesheets[serial]={qtiClass:"stylesheet",attributes:{href:urlUtil.route("loadStylesheet","SharedStimulusStyling","taoMediaManager",{uri:passageUri,stylesheet:element.name}),media:"all",title:"",type:"text/css"},serial:serial}}),setTimeout(function(){formatStyles.getStyles("stylesheet",!0)},1e3)}).catch()))}}),Promise.all(requests).then(function(){return itemData})}function checkAndInjectStylesInItemData(){var itemData=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{},itemDataString=JSON.stringify(itemData);if(/"qtiClass":"include"/.test(itemDataString)){var elements=getPassagesFromItemData(itemData);return injectPassagesStylesInItemData(elements,itemData)}return Promise.resolve(itemData)}return{getPassagesFromElement:getPassagesFromElement,getPassagesFromItemData:getPassagesFromItemData,injectPassagesStylesInItemData:injectPassagesStylesInItemData,checkAndInjectStylesInItemData:checkAndInjectStylesInItemData}}),define("taoMediaManager/richPassage/injectStylesInItemData",["taoMediaManager/richPassage/helpers"],function(helpers){"use strict";return helpers.checkAndInjectStylesInItemData}),define("taoMediaManager/loader/injectStylesInItemData.bundle",function(){});
//# sourceMappingURL=injectStylesInItemData.min.js.map